<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°†æ‰‹ç‰Œè½¬æ¢å™¨ - Tenhou JSONç”Ÿæˆå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2d5016;
            --secondary: #4a7c2c;
            --accent: #d4af37;
            --bg: #f5f0e8;
            --card-bg: #ffffff;
            --text: #2c2c2c;
            --text-light: #666;
            --border: #d4c5b0;
            --error: #c62828;
            --success: #2e7d32;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            color: var(--text);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease-out;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 0 rgba(212, 175, 55, 0.2);
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: backwards;
        }

        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.3s; }

        h2 {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: 'ğŸ€„';
            font-size: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 124, 44, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 1.2rem;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.4rem;
            font-style: italic;
        }

        button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
            font-family: 'Noto Sans SC', sans-serif;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(45, 80, 22, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #5a5a5a 0%, #3a3a3a 100%);
        }

        .btn-link {
            background: transparent;
            color: var(--secondary);
            box-shadow: none;
            padding: 0.9rem 1.5rem;
            border: 2px solid var(--secondary);
        }

        .btn-link:hover {
            background: var(--secondary);
            color: white;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        .message.error {
            background: #ffebee;
            color: var(--error);
            border-left: 4px solid var(--error);
        }

        .message.success {
            background: #e8f5e9;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .example {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
            margin-top: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ€„ éº»å°†æ‰‹ç‰Œè½¬æ¢å™¨</h1>
            <p class="subtitle">å°†æ‰‹ç‰Œå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤©å‡¤(Tenhou) JSONæ ¼å¼</p>
        </header>

        <div class="card">
            <h2>è¾“å…¥æ‰‹ç‰Œä¿¡æ¯</h2>
            
            <div class="input-group">
                <label for="playerHand">è‡ªå·±çš„æ‰‹ç‰Œå­—ç¬¦ä¸²</label>
                <input type="text" id="playerHand" placeholder="ä¾‹å¦‚: 1123456789m1s1p44z">
                <div class="help-text">æ ¼å¼ï¼šæ•°å­—+m(è¬) / p(ç­’) / s(ç´¢) / z(å­—ç‰Œï¼Œ1-7å¯¹åº”ä¸œå—è¥¿åŒ—ç™½å‘ä¸­)ï¼Œå…±14å¼ ï¼ˆå‰13å¼ æ‰‹ç‰Œ+æœ€å1å¼ æ‘¸ç‰Œï¼‰<br>èµ¤å®ç‰Œï¼š0m=èµ¤5è¬, 0p=èµ¤5ç­’, 0s=èµ¤5ç´¢ï¼ˆæ¯ç§æœ€å¤š1å¼ ï¼‰</div>
            </div>

            <div class="input-group">
                <label for="turn">å·¡ç›® (ç¬¬å‡ å·¡)</label>
                <input type="number" id="turn" value="1" min="1" max="18">
                <div class="help-text">ä¸œå®¶ç¬¬1å·¡ï¼Œå—å®¶ç¬¬2å·¡ï¼Œè¥¿å®¶ç¬¬3å·¡ï¼ŒåŒ—å®¶ç¬¬4å·¡ï¼Œç„¶åå¾ªç¯ã€‚è¾“å…¥å½“å‰æ˜¯ç¬¬å‡ å·¡</div>
            </div>

            <div class="input-group">
                <label for="playerPosition">è‡ªå·±çš„åº§ä½</label>
                <select id="playerPosition" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <option value="0">ä¸œå®¶ (0)</option>
                    <option value="1">å—å®¶ (1)</option>
                    <option value="2">è¥¿å®¶ (2)</option>
                    <option value="3">åŒ—å®¶ (3)</option>
                </select>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="dora">å®ç‰ŒæŒ‡ç¤ºç‰Œï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="dora" placeholder="ç•™ç©ºåˆ™éšæœºï¼Œå¦‚: 1m æˆ– 27">
                    <div class="help-text">å¯ä»¥è¾“å…¥ç‰Œå(1m/2p/3s/4z)æˆ–ç¼–å·(11-47)</div>
                </div>
                
                <div class="input-group">
                    <label for="uradora">é‡Œå®ç‰ŒæŒ‡ç¤ºç‰Œï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="uradora" placeholder="ç•™ç©ºåˆ™éšæœºï¼Œå¦‚: 2p æˆ– 25">
                    <div class="help-text">å¯ä»¥è¾“å…¥ç‰Œå(1m/2p/3s/4z)æˆ–ç¼–å·(11-47)</div>
                </div>
            </div>

            <div class="example">
                <strong>ç¤ºä¾‹ï¼š</strong> 1123456789m1s1p44z
                <br>è¡¨ç¤ºï¼šä¸€ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹è¬ + ä¸€ç´¢ + ä¸€ç­’ + ä¸œä¸œï¼ˆå…±14å¼ ï¼Œæœ€åä¸€å¼ "ä¸œ"æ˜¯æ‘¸ç‰Œï¼‰
                <br><strong>èµ¤å®ç‰Œç¤ºä¾‹ï¼š</strong> 112340678m1s1p44z
                <br>è¡¨ç¤ºï¼šä¸€ä¸€äºŒä¸‰å››èµ¤äº”å…­ä¸ƒå…«è¬ + ä¸€ç´¢ + ä¸€ç­’ + ä¸œä¸œï¼ˆå…±14å¼ ï¼Œæœ€åä¸€å¼ "ä¸œ"æ˜¯æ‘¸ç‰Œï¼‰
            </div>
        </div>

        <div class="card">
            <div class="button-group">
                <button onclick="convertToTenhou()">ğŸ² ç”Ÿæˆ Tenhou JSON</button>
                <button class="btn-secondary" onclick="copyJSON()">ğŸ“‹ å¤åˆ¶ JSON</button>
                <button class="btn-link" onclick="openTenhou()">ğŸ”— åœ¨å¤©å‡¤éªŒè¯</button>
            </div>
            <div id="message"></div>
        </div>

        <div class="card">
            <h2>ç”Ÿæˆçš„ JSON ç»“æœ</h2>
            <textarea id="output" readonly placeholder="ç”Ÿæˆçš„JSONå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>

    <script>
        // éº»å°†ç‰Œç¼–ç æ˜ å°„
        const tileMap = {
            // è¬ (11-19, 51ä¸ºèµ¤5è¬)
            'm': { start: 11, red: 51 },
            // ç­’ (21-29, 52ä¸ºèµ¤5ç­’)
            'p': { start: 21, red: 52 },
            // ç´¢ (31-39, 53ä¸ºèµ¤5ç´¢)
            's': { start: 31, red: 53 },
            // å­—ç‰Œ (41-47: ä¸œå—è¥¿åŒ—ç™½å‘ä¸­)
            'z': { start: 41 }
        };

        function parseTileString(handStr) {
            const tiles = [];
            let currentNums = '';
            
            for (let char of handStr) {
                if (/\d/.test(char)) {
                    currentNums += char;
                } else if (char in tileMap) {
                    const suit = tileMap[char];
                    for (let num of currentNums) {
                        const numVal = parseInt(num);
                        
                        // å¤„ç†èµ¤å®ç‰Œï¼š0è¡¨ç¤ºçº¢äº”
                        if (numVal === 0) {
                            if (char === 'm') tiles.push(51); // èµ¤5è¬
                            else if (char === 'p') tiles.push(52); // èµ¤5ç­’
                            else if (char === 's') tiles.push(53); // èµ¤5ç´¢
                        }
                        // å¯¹äºå­—ç‰Œï¼Œç›´æ¥ä½¿ç”¨æ•°å­—1-7
                        else if (char === 'z') {
                            tiles.push(suit.start + numVal - 1);
                        } else {
                            // è¬ã€ç­’ã€ç´¢ä½¿ç”¨1-9
                            tiles.push(suit.start + numVal - 1);
                        }
                    }
                    currentNums = '';
                }
            }
            
            return tiles;
        }

        // è§£æå•å¼ ç‰Œçš„è¾“å…¥ï¼ˆæ”¯æŒ "1m" æˆ– "11" æ ¼å¼ï¼‰
        function parseSingleTile(input) {
            if (!input || input.trim() === '') {
                return null;
            }
            
            input = input.trim();
            
            // å¦‚æœæ˜¯çº¯æ•°å­—ï¼Œç›´æ¥è¿”å›
            if (/^\d+$/.test(input)) {
                const num = parseInt(input);
                // éªŒè¯èŒƒå›´ï¼š11-19, 21-29, 31-39, 41-47
                if ((num >= 11 && num <= 19) || 
                    (num >= 21 && num <= 29) || 
                    (num >= 31 && num <= 39) || 
                    (num >= 41 && num <= 47)) {
                    return num;
                }
                return null;
            }
            
            // å¦‚æœæ˜¯ç‰Œåæ ¼å¼ï¼ˆå¦‚ 1m, 2p, 3s, 4zï¼‰ï¼Œè§£æå®ƒ
            const tiles = parseTileString(input);
            return tiles.length > 0 ? tiles[0] : null;
        }

        // ç»Ÿè®¡ç‰Œçš„ä½¿ç”¨æ•°é‡
        function countTiles(tiles) {
            const count = {};
            for (let tile of tiles) {
                count[tile] = (count[tile] || 0) + 1;
            }
            return count;
        }

        function generateRandomTiles(count, tileCount, excludeTiles = []) {
            const tiles = [];
            const excludeSet = new Set(excludeTiles);
            
            // æ‰€æœ‰å¯èƒ½çš„ç‰Œ (11-19, 21-29, 31-39, 41-47, 51-53èµ¤å®ç‰Œ)
            const allTiles = [];
            for (let i = 1; i <= 9; i++) {
                allTiles.push(11 + i - 1); // è¬
                allTiles.push(21 + i - 1); // ç­’
                allTiles.push(31 + i - 1); // ç´¢
            }
            for (let i = 1; i <= 7; i++) {
                allTiles.push(41 + i - 1); // å­—ç‰Œ
            }
            // æ·»åŠ èµ¤å®ç‰Œ
            allTiles.push(51, 52, 53); // èµ¤5è¬ã€èµ¤5ç­’ã€èµ¤5ç´¢
            
            // éšæœºé€‰æ‹©ï¼Œç¡®ä¿æ¯ç§ç‰Œä¸è¶…è¿‡4å¼ 
            // ç‰¹åˆ«æ³¨æ„ï¼š5å’Œçº¢5è¦åˆå¹¶è®¡ç®—ï¼Œä¸”çº¢5æœ€å¤š1å¼ 
            let attempts = 0;
            while (tiles.length < count && attempts < 1000) {
                const tile = allTiles[Math.floor(Math.random() * allTiles.length)];
                
                // è·³è¿‡æ’é™¤çš„ç‰Œ
                if (excludeSet.has(tile)) {
                    attempts++;
                    continue;
                }
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨è¿™å¼ ç‰Œ
                let canUse = false;
                
                // èµ¤5è¬ (51) - æœ€å¤šåªèƒ½æœ‰1å¼ ï¼Œä¸”è¦å’Œ 5è¬ (15) åˆå¹¶è®¡ç®—
                if (tile === 51) {
                    const red5m = (tileCount[51] || 0);
                    const normal5m = (tileCount[15] || 0);
                    canUse = red5m === 0 && (red5m + normal5m) < 4;
                }
                // èµ¤5ç­’ (52) - æœ€å¤šåªèƒ½æœ‰1å¼ ï¼Œä¸”è¦å’Œ 5ç­’ (25) åˆå¹¶è®¡ç®—
                else if (tile === 52) {
                    const red5p = (tileCount[52] || 0);
                    const normal5p = (tileCount[25] || 0);
                    canUse = red5p === 0 && (red5p + normal5p) < 4;
                }
                // èµ¤5ç´¢ (53) - æœ€å¤šåªèƒ½æœ‰1å¼ ï¼Œä¸”è¦å’Œ 5ç´¢ (35) åˆå¹¶è®¡ç®—
                else if (tile === 53) {
                    const red5s = (tileCount[53] || 0);
                    const normal5s = (tileCount[35] || 0);
                    canUse = red5s === 0 && (red5s + normal5s) < 4;
                }
                // 5è¬ (15) éœ€è¦å’Œèµ¤5è¬ (51) åˆå¹¶è®¡ç®—
                else if (tile === 15) {
                    const total = (tileCount[51] || 0) + (tileCount[15] || 0);
                    canUse = total < 4;
                }
                // 5ç­’ (25) éœ€è¦å’Œèµ¤5ç­’ (52) åˆå¹¶è®¡ç®—
                else if (tile === 25) {
                    const total = (tileCount[52] || 0) + (tileCount[25] || 0);
                    canUse = total < 4;
                }
                // 5ç´¢ (35) éœ€è¦å’Œèµ¤5ç´¢ (53) åˆå¹¶è®¡ç®—
                else if (tile === 35) {
                    const total = (tileCount[53] || 0) + (tileCount[35] || 0);
                    canUse = total < 4;
                }
                // å…¶ä»–ç‰Œæ­£å¸¸åˆ¤æ–­
                else {
                    canUse = (tileCount[tile] || 0) < 4;
                }
                
                if (canUse) {
                    tiles.push(tile);
                    tileCount[tile] = (tileCount[tile] || 0) + 1;
                }
                attempts++;
            }
            
            return tiles;
        }

        function generateGameData(turn, playerHand, playerDrawnTile, playerPos, doraIndicator, uradoraIndicator) {
            // å…¨å±€ç‰Œè®¡æ•°å™¨ - ç»Ÿè®¡æ‰€æœ‰å·²ä½¿ç”¨çš„ç‰Œï¼ˆåŒ…æ‹¬å®ç‰ŒæŒ‡ç¤ºç‰Œï¼‰
            const tileCount = {};
            const excludeTiles = []; // éœ€è¦æ’é™¤çš„ç‰Œï¼ˆå®ç‰ŒæŒ‡ç¤ºç‰Œï¼‰
            
            // å…ˆè®¡å…¥å®ç‰ŒæŒ‡ç¤ºç‰Œ
            if (doraIndicator !== null) {
                tileCount[doraIndicator] = (tileCount[doraIndicator] || 0) + 1;
                excludeTiles.push(doraIndicator);
            }
            if (uradoraIndicator !== null) {
                tileCount[uradoraIndicator] = (tileCount[uradoraIndicator] || 0) + 1;
                excludeTiles.push(uradoraIndicator);
            }
            
            // ç”Ÿæˆ4å®¶çš„æ•°æ®
            const hands = [[], [], [], []]; // æ‰‹ç‰Œï¼ˆ13å¼ ï¼‰
            const draws = [[], [], [], []]; // æ‘¸ç‰Œ
            const discards = [[], [], [], []]; // å‡ºç‰Œ
            
            // å…ˆè®¾ç½®ç©å®¶çš„æ‰‹ç‰Œï¼ˆ13å¼ ï¼‰å¹¶è®¡å…¥è®¡æ•°å™¨
            hands[playerPos] = [...playerHand];
            for (let tile of playerHand) {
                tileCount[tile] = (tileCount[tile] || 0) + 1;
            }
            
            // ç©å®¶çš„æ‘¸ç‰Œä¹Ÿè¦è®¡å…¥
            tileCount[playerDrawnTile] = (tileCount[playerDrawnTile] || 0) + 1;
            
            // ç”Ÿæˆå…¶ä»–ä¸‰å®¶çš„æ‰‹ç‰Œï¼ˆå„13å¼ ï¼‰
            for (let i = 0; i < 4; i++) {
                if (i !== playerPos) {
                    hands[i] = generateRandomTiles(13, tileCount, excludeTiles);
                }
            }
            
            // è®¡ç®—å½“å‰è½®åˆ°è°ï¼šä¸œå®¶(0)å…ˆå¼€å§‹ï¼ŒæŒ‰0->1->2->3é¡ºåº
            const currentPlayer = (turn - 1) % 4;
            
            // ç”Ÿæˆæ¯å·¡çš„æ‘¸ç‰Œå’Œå‡ºç‰Œ
            const totalActions = (turn - 1) * 4 + (currentPlayer + 1);
            
            for (let action = 0; action < totalActions; action++) {
                const p = action % 4; // å½“å‰æ˜¯å“ªä¸ªç©å®¶
                
                let drawTile;
                
                // å¦‚æœæ˜¯ç©å®¶ä¸”æ˜¯å½“å‰æœ€åä¸€ä¸ªåŠ¨ä½œï¼Œä½¿ç”¨ç©å®¶è¾“å…¥çš„æ‘¸ç‰Œ
                if (p === playerPos && action === totalActions - 1) {
                    drawTile = playerDrawnTile;
                } else {
                    // å…¶ä»–æƒ…å†µéšæœºç”Ÿæˆæ‘¸ç‰Œ
                    drawTile = generateRandomTiles(1, tileCount, excludeTiles)[0];
                    if (drawTile === undefined) {
                        console.error('æ— æ³•ç”Ÿæˆæ‘¸ç‰Œï¼Œå¯èƒ½ç‰Œå·²ç”¨å®Œ');
                        break;
                    }
                }
                
                draws[p].push(drawTile);
                
                // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªåŠ¨ä½œï¼Œéœ€è¦å‡ºç‰Œ
                if (action < totalActions - 1) {
                    // æ‰“å‡ºåˆšæ‘¸çš„ç‰Œï¼Œå¹¶ä»è®¡æ•°å™¨ä¸­å‡å»
                    discards[p].push(drawTile);
                    tileCount[drawTile] = (tileCount[drawTile] || 0) - 1;
                    if (tileCount[drawTile] <= 0) {
                        delete tileCount[drawTile];
                    }
                }
            }
            
            return { hands, draws, discards };
        }

        function validateTileCounts(hands, draws, doraIndicator, uradoraIndicator) {
            // éªŒè¯æ‰€æœ‰æ‰‹ç‰Œ+æ‘¸ç‰Œ+å®ç‰ŒæŒ‡ç¤ºç‰Œä¸­ï¼Œæ¯ç§ç‰Œä¸è¶…è¿‡4å¼ 
            // ç‰¹åˆ«æ³¨æ„ï¼š5å’Œçº¢5è¦åˆå¹¶è®¡ç®—ï¼Œä¸”çº¢5æœ€å¤š1å¼ 
            const totalCount = {};
            
            // ç»Ÿè®¡æ‰€æœ‰æ‰‹ç‰Œ
            for (let hand of hands) {
                for (let tile of hand) {
                    totalCount[tile] = (totalCount[tile] || 0) + 1;
                }
            }
            
            // ç»Ÿè®¡æ‰€æœ‰æ‘¸ç‰Œ
            for (let draw of draws) {
                for (let tile of draw) {
                    totalCount[tile] = (totalCount[tile] || 0) + 1;
                }
            }
            
            // ç»Ÿè®¡å®ç‰ŒæŒ‡ç¤ºç‰Œ
            if (doraIndicator !== null) {
                totalCount[doraIndicator] = (totalCount[doraIndicator] || 0) + 1;
            }
            if (uradoraIndicator !== null) {
                totalCount[uradoraIndicator] = (totalCount[uradoraIndicator] || 0) + 1;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡é™åˆ¶çš„ç‰Œ
            const errors = [];
            
            // æ£€æŸ¥èµ¤å®ç‰Œæ˜¯å¦è¶…è¿‡1å¼ 
            if ((totalCount[51] || 0) > 1) {
                errors.push(`èµ¤5è¬(51)å‡ºç°äº† ${totalCount[51]} æ¬¡ï¼ˆæœ€å¤š1æ¬¡ï¼‰`);
            }
            if ((totalCount[52] || 0) > 1) {
                errors.push(`èµ¤5ç­’(52)å‡ºç°äº† ${totalCount[52]} æ¬¡ï¼ˆæœ€å¤š1æ¬¡ï¼‰`);
            }
            if ((totalCount[53] || 0) > 1) {
                errors.push(`èµ¤5ç´¢(53)å‡ºç°äº† ${totalCount[53]} æ¬¡ï¼ˆæœ€å¤š1æ¬¡ï¼‰`);
            }
            
            // æ£€æŸ¥5è¬å’Œèµ¤5è¬çš„æ€»æ•°
            const m5Total = (totalCount[15] || 0) + (totalCount[51] || 0);
            if (m5Total > 4) {
                errors.push(`5è¬(15)å’Œèµ¤5è¬(51)åˆè®¡å‡ºç°äº† ${m5Total} æ¬¡ï¼ˆè¶…è¿‡4æ¬¡ï¼‰`);
            }
            
            // æ£€æŸ¥5ç­’å’Œèµ¤5ç­’çš„æ€»æ•°
            const p5Total = (totalCount[25] || 0) + (totalCount[52] || 0);
            if (p5Total > 4) {
                errors.push(`5ç­’(25)å’Œèµ¤5ç­’(52)åˆè®¡å‡ºç°äº† ${p5Total} æ¬¡ï¼ˆè¶…è¿‡4æ¬¡ï¼‰`);
            }
            
            // æ£€æŸ¥5ç´¢å’Œèµ¤5ç´¢çš„æ€»æ•°
            const s5Total = (totalCount[35] || 0) + (totalCount[53] || 0);
            if (s5Total > 4) {
                errors.push(`5ç´¢(35)å’Œèµ¤5ç´¢(53)åˆè®¡å‡ºç°äº† ${s5Total} æ¬¡ï¼ˆè¶…è¿‡4æ¬¡ï¼‰`);
            }
            
            // æ£€æŸ¥å…¶ä»–ç‰Œï¼ˆæ’é™¤5å’Œçº¢5ï¼‰
            for (let tile in totalCount) {
                const tileNum = parseInt(tile);
                // è·³è¿‡5å’Œçº¢5ï¼Œå› ä¸ºå·²ç»å•ç‹¬æ£€æŸ¥è¿‡
                if ([15, 25, 35, 51, 52, 53].includes(tileNum)) {
                    continue;
                }
                
                if (totalCount[tile] > 4) {
                    errors.push(`ç‰Œ ${tile} å‡ºç°äº† ${totalCount[tile]} æ¬¡ï¼ˆè¶…è¿‡4æ¬¡ï¼‰`);
                }
            }
            
            return errors;
        }

        function convertToTenhou() {
            const handStr = document.getElementById('playerHand').value.trim();
            const turn = parseInt(document.getElementById('turn').value);
            const playerPos = parseInt(document.getElementById('playerPosition').value);
            const doraInput = document.getElementById('dora').value.trim();
            const uradoraInput = document.getElementById('uradora').value.trim();
            const messageDiv = document.getElementById('message');
            const outputArea = document.getElementById('output');

            if (!handStr) {
                messageDiv.innerHTML = '<div class="message error">âš ï¸ è¯·è¾“å…¥æ‰‹ç‰Œå­—ç¬¦ä¸²</div>';
                return;
            }

            try {
                // è§£ææ‰‹ç‰Œ
                const playerTiles = parseTileString(handStr);
                
                // æ‰‹ç‰Œåº”è¯¥æ˜¯14å¼ ï¼ˆåŒ…å«æ‘¸ç‰Œï¼‰
                if (playerTiles.length !== 14) {
                    messageDiv.innerHTML = '<div class="message error">âš ï¸ æ‰‹ç‰Œæ•°é‡å¿…é¡»æ˜¯14å¼ ï¼ˆ13å¼ æ‰‹ç‰Œ+1å¼ æ‘¸ç‰Œï¼‰</div>';
                    return;
                }
                
                // åˆ†ç¦»æ‰‹ç‰Œå’Œæ‘¸ç‰Œï¼šå‰13å¼ æ˜¯æ‰‹ç‰Œï¼Œç¬¬14å¼ æ˜¯æ‘¸ç‰Œ
                const actualHand = playerTiles.slice(0, 13);
                const drawnTile = playerTiles[13];

                // è§£æå®ç‰ŒæŒ‡ç¤ºç‰Œï¼ˆå¦‚æœæœ‰è¾“å…¥ï¼‰
                let doraIndicator = parseSingleTile(doraInput);
                let uradoraIndicator = parseSingleTile(uradoraInput);
                
                // å¦‚æœæ²¡æœ‰è¾“å…¥å®ç‰Œï¼Œç¨åéšæœºç”Ÿæˆ
                // å…ˆè¿›è¡Œåˆæ­¥éªŒè¯
                if (doraIndicator !== null) {
                    // éªŒè¯å®ç‰Œæ ¼å¼
                    if (doraIndicator < 11 || doraIndicator > 47 || 
                        (doraIndicator > 19 && doraIndicator < 21) ||
                        (doraIndicator > 29 && doraIndicator < 31) ||
                        (doraIndicator > 39 && doraIndicator < 41)) {
                        messageDiv.innerHTML = '<div class="message error">âš ï¸ å®ç‰ŒæŒ‡ç¤ºç‰Œæ ¼å¼é”™è¯¯</div>';
                        return;
                    }
                }
                
                if (uradoraIndicator !== null) {
                    // éªŒè¯é‡Œå®ç‰Œæ ¼å¼
                    if (uradoraIndicator < 11 || uradoraIndicator > 47 || 
                        (uradoraIndicator > 19 && uradoraIndicator < 21) ||
                        (uradoraIndicator > 29 && uradoraIndicator < 31) ||
                        (uradoraIndicator > 39 && uradoraIndicator < 41)) {
                        messageDiv.innerHTML = '<div class="message error">âš ï¸ é‡Œå®ç‰ŒæŒ‡ç¤ºç‰Œæ ¼å¼é”™è¯¯</div>';
                        return;
                    }
                }

                // å°è¯•ç”Ÿæˆæœ‰æ•ˆçš„æ•°æ®ï¼Œæœ€å¤šé‡è¯•10æ¬¡
                let gameData = null;
                let finalDoraIndicator = doraIndicator;
                let finalUradoraIndicator = uradoraIndicator;
                let attempts = 0;
                const maxAttempts = 10;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    // åˆ›å»ºä¸´æ—¶ç‰Œè®¡æ•°å™¨ç”¨äºç”Ÿæˆå®ç‰Œ
                    const tempTileCount = {};
                    for (let tile of actualHand) {
                        tempTileCount[tile] = (tempTileCount[tile] || 0) + 1;
                    }
                    // ä¹Ÿè¦è®¡å…¥ç©å®¶çš„æ‘¸ç‰Œ
                    tempTileCount[drawnTile] = (tempTileCount[drawnTile] || 0) + 1;
                    
                    // å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šå®ç‰Œï¼Œéšæœºç”Ÿæˆ
                    if (doraIndicator === null) {
                        // éšæœºç”Ÿæˆä¸€å¼ å®ç‰ŒæŒ‡ç¤ºç‰Œï¼ˆæ’é™¤èµ¤å®ç‰Œ51-53ï¼‰
                        const doraCandidates = [];
                        for (let i = 1; i <= 9; i++) {
                            doraCandidates.push(11 + i - 1, 21 + i - 1, 31 + i - 1);
                        }
                        for (let i = 1; i <= 7; i++) {
                            doraCandidates.push(41 + i - 1);
                        }
                        finalDoraIndicator = doraCandidates[Math.floor(Math.random() * doraCandidates.length)];
                    }
                    
                    tempTileCount[finalDoraIndicator] = (tempTileCount[finalDoraIndicator] || 0) + 1;
                    
                    // å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šé‡Œå®ç‰Œï¼Œéšæœºç”Ÿæˆ
                    if (uradoraIndicator === null) {
                        // éšæœºç”Ÿæˆä¸€å¼ é‡Œå®ç‰ŒæŒ‡ç¤ºç‰Œï¼ˆæ’é™¤èµ¤å®ç‰Œ51-53å’Œå·²é€‰çš„å®ç‰Œï¼‰
                        const uradoraCandidates = [];
                        for (let i = 1; i <= 9; i++) {
                            uradoraCandidates.push(11 + i - 1, 21 + i - 1, 31 + i - 1);
                        }
                        for (let i = 1; i <= 7; i++) {
                            uradoraCandidates.push(41 + i - 1);
                        }
                        // è¿‡æ»¤æ‰å·²ä½¿ç”¨è¶…è¿‡3æ¬¡çš„ç‰Œ
                        const availableUra = uradoraCandidates.filter(tile => {
                            if (tile === 15 || tile === 25 || tile === 35) {
                                // 5éœ€è¦è€ƒè™‘çº¢5
                                const normal5 = tempTileCount[tile] || 0;
                                const red5 = tempTileCount[tile + 36] || 0; // 51-15=36, 52-25=27, 53-35=18
                                return (normal5 + red5) < 4;
                            }
                            return (tempTileCount[tile] || 0) < 4;
                        });
                        
                        if (availableUra.length > 0) {
                            finalUradoraIndicator = availableUra[Math.floor(Math.random() * availableUra.length)];
                        } else {
                            // å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç‰Œï¼Œéšæœºé€‰ä¸€ä¸ª
                            finalUradoraIndicator = uradoraCandidates[Math.floor(Math.random() * uradoraCandidates.length)];
                        }
                    }
                    
                    gameData = generateGameData(turn, actualHand, drawnTile, playerPos, finalDoraIndicator, finalUradoraIndicator);
                    
                    // éªŒè¯ç‰Œçš„æ•°é‡ï¼ˆåŒ…æ‹¬å®ç‰Œï¼‰
                    const errors = validateTileCounts(gameData.hands, gameData.draws, finalDoraIndicator, finalUradoraIndicator);
                    if (errors.length === 0) {
                        // ç”ŸæˆæˆåŠŸï¼Œè·³å‡ºå¾ªç¯
                        break;
                    }
                    
                    // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•è¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                    if (attempts === maxAttempts) {
                        messageDiv.innerHTML = `<div class="message error">âš ï¸ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è°ƒæ•´æ‰‹ç‰Œ</div>`;
                        console.error('å°è¯•10æ¬¡åä»ç„¶ç”Ÿæˆå¤±è´¥:', errors);
                        return;
                    }
                    
                    // ç»§ç»­é‡è¯•ï¼ˆå¦‚æœå®ç‰Œæ˜¯éšæœºçš„ï¼Œä¸‹æ¬¡ä¼šç”Ÿæˆä¸åŒçš„å®ç‰Œï¼‰
                    console.log(`ç¬¬${attempts}æ¬¡ç”Ÿæˆæœ‰é—®é¢˜ï¼Œé‡è¯•ä¸­...`, errors);
                }

                // æ„å»º Tenhou JSON (å®Œæ•´æ ¼å¼)
                const tenhouJSON = {
                    "title": ["éº»å°†ç‰Œå±€", ""],
                    "name": ["ç©å®¶1", "ç©å®¶2", "ç©å®¶3", "ç©å®¶4"],
                    "rule": {
                        "aka": 1
                    },
                    "log": [
                        [
                            [0, 0, 0], // [0] åœºã€æœ¬åœºã€ç«‹ç›´æ£’
                            [25000, 25000, 25000, 25000], // [1] å„å®¶ç‚¹æ•°
                            [finalDoraIndicator], // [2] å®ç‰ŒæŒ‡ç¤ºç‰Œ
                            [finalUradoraIndicator], // [3] é‡Œå®ç‰ŒæŒ‡ç¤ºç‰Œ
                            gameData.hands[0], // [4] ä¸œå®¶æ‰‹ç‰Œ
                            gameData.draws[0], // [5] ä¸œå®¶æ‘¸ç‰Œ
                            gameData.discards[0], // [6] ä¸œå®¶å‡ºç‰Œ
                            gameData.hands[1], // [7] å—å®¶æ‰‹ç‰Œ
                            gameData.draws[1], // [8] å—å®¶æ‘¸ç‰Œ
                            gameData.discards[1], // [9] å—å®¶å‡ºç‰Œ
                            gameData.hands[2], // [10] è¥¿å®¶æ‰‹ç‰Œ
                            gameData.draws[2], // [11] è¥¿å®¶æ‘¸ç‰Œ
                            gameData.discards[2], // [12] è¥¿å®¶å‡ºç‰Œ
                            gameData.hands[3], // [13] åŒ—å®¶æ‰‹ç‰Œ
                            gameData.draws[3], // [14] åŒ—å®¶æ‘¸ç‰Œ
                            gameData.discards[3], // [15] åŒ—å®¶å‡ºç‰Œ
                            ["ä¸æ˜"] // [16] ç»“æœï¼ˆä¸æ˜è¡¨ç¤ºæœªç»“æŸï¼‰
                        ]
                    ]
                };

                const jsonStr = JSON.stringify(tenhouJSON);
                outputArea.value = jsonStr;
                messageDiv.innerHTML = '<div class="message success">âœ“ JSONç”ŸæˆæˆåŠŸï¼å¯ä»¥å¤åˆ¶æˆ–åœ¨å¤©å‡¤éªŒè¯</div>';

            } catch (error) {
                messageDiv.innerHTML = `<div class="message error">âš ï¸ è½¬æ¢å¤±è´¥: ${error.message}</div>`;
                console.error(error);
            }
        }

        function copyJSON() {
            const output = document.getElementById('output');
            const messageDiv = document.getElementById('message');
            
            if (!output.value) {
                messageDiv.innerHTML = '<div class="message error">âš ï¸ æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ï¼Œè¯·å…ˆç”ŸæˆJSON</div>';
                return;
            }

            output.select();
            document.execCommand('copy');
            messageDiv.innerHTML = '<div class="message success">âœ“ JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>';
        }

        function openTenhou() {
            const output = document.getElementById('output').value;
            const messageDiv = document.getElementById('message');
            
            if (!output) {
                messageDiv.innerHTML = '<div class="message error">âš ï¸ è¯·å…ˆç”ŸæˆJSONå†éªŒè¯</div>';
                return;
            }

            try {
                const jsonData = JSON.parse(output);
                const jsonStr = JSON.stringify(jsonData);
                const encodedJSON = encodeURIComponent(jsonStr);
                const url = `https://tenhou.net/6/#json=${encodedJSON}`;
                window.open(url, '_blank');
            } catch (error) {
                messageDiv.innerHTML = '<div class="message error">âš ï¸ JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ‰“å¼€å¤©å‡¤</div>';
            }
        }

        // ç¤ºä¾‹è‡ªåŠ¨å¡«å……
        window.addEventListener('load', () => {
            document.getElementById('playerHand').value = '1123456789m1s1p44z';
        });
    </script>
</body>
</html>
